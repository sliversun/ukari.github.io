<html>
  <head>
    <title id="title">blog</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="./css/style.css" type="text/css" />
    <link rel="stylesheet" href="./css/layout.css" type="text/css" />
  </head>
  <body>
    <div id="notification_container">
      <div id="notification">no message</div>
      <div id="hide">X</div>
    </div>
    <div id="article_lists"></div>
    <div id="article_container"></div>
  </body>
</html>
<script src="js/request.js" type="text/javascript"></script>
<script src="js/js.cookie.js" type="text/javascript"></script>
<script language="javascript">
  var close_all_containers = regist_container_hide_controller(["article_lists", "article_container"]);
     base_request("GET", "http://"+window.location.host+"/config.json", undefined, load_config, document.getElementById("notification"));

     function load_config(data, target)
     {
       var list = Object.keys(data);
       for (var i in list) {
         var v = list[i];
         Cookies.set(v, data[v]);
         target.innerHTML += "load config: "+v+" = "+data[v]+newline();
       }
     }

     base_request("GET", gists_url(), undefined, get_articles, document.getElementById("article_lists"));

     function get_articles(data, target)
     {
       close_all_containers();
       var file = data[0];
       var articles = new Array();
       for (var i = 0; i < data.length; i += 1) {
         if (articlep(data[i])) {
           articles[articles.length] = new Article(data[i]);
         }
       }
       show_articles(articles, target);
       function show_articles(articles, target)
       {
         for (var i = 0; i < articles.length; i += 1){
           var article = articles[i];
           var buf = divtag("article",
                         divtag("title", article.title) +
                         divtag("description", article.description),
                         "click_lists",
                         article.id);
           target.innerHTML += buf;
         }
       }
     }

     function click_lists(gist_hash)
     {
       base_request("GET", gist_url(gist_hash), undefined, get_article, document.getElementById("article_container"));
     }

     function get_article(data, target)
     {
       close_all_containers();
       var article = new Article(data);
       show_article(article, target);
       function show_article(article, target)
       {
         var buf = "";
         buf += divtag("article",
                       divtag("title", article.title) +
                       divtag("create_time", article.create_time) +
                       divtag("update_time", article.update_time) +
                       divtag("content", article.content));
         target.innerHTML = buf;
       }
     }

     function divtag(name, content, listener, arg)
     {
       var listener_str;
       if (arg == undefined) {
         arg = "";
       }
       if (listener != undefined) {
         listener_str = " onclick=" + listener + '("' + arg + '")';
       }
       if (listener_str == undefined) {
         listener_str = "";
       }
       return "<div name=" + name + listener_str +">" + content + "</>";
     }

     function Article(file)
     {
       //only fetch the first file
       var gist = file["files"][Object.keys(file["files"])[0]];
       this.title = gist["filename"];
       this.raw_url = gist["raw_url"];
       var des = file["description"];
       this.content = gist["content"];
       this.description = des.substring(des.indexOf(" ") + 1, des.length);
       this.id = file["id"];
       this.create_time = file["created_at"];
       this.update_time = file["updated_at"];
     }

     function articlep(file)
     {
       var description = file["description"];
       var shebang = description.substring(0,description.indexOf(" "));
       return shebang == "#!unmj";
     }

     function gists_url()
     {
       var github_username = Cookies.get("github_username");
       var gists_url = "https://api.github.com/users/"+github_username+"/gists";
       return gists_url;
     }

     function gist_url(gist_hash)
     {
       var gist_url = "https://api.github.com/gists/" + gist_hash;
       return gist_url;
     }

     function newline()
     {
       return "<br>";
     }

     function regist_container_hide_controller(list)
     {
       var containers = new Array();
       for (var i = 0; i < list.length; i += 1) {
         containers[i] = document.getElementById(list[i]);
       }
       return function ()
       {
         for (var i = 0; i < container.length; i += 1) {
           container[i].hidden = true;
         }
       }
     }
</script>
